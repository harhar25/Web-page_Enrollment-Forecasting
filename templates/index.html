<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACLC College Enrollment Forecast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --bed-color: #e74a3b;
            --ced-color: #1cc88a;
        }
        
        body {
            background-color: #f8f9fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-card {
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            background: white;
            border: none;
            margin-bottom: 1.5rem;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        
        .chart-container {
            position: relative;
            margin: auto;
            height: 400px;
            padding: 15px;
        }
        
        .metrics-badge {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 5px;
            font-weight: 500;
            background: rgba(78, 115, 223, 0.1);
            color: var(--primary-color);
        }
        
        .navbar {
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, var(--primary-color), var(--success-color));
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .department-btn {
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
            border: none;
            color: white;
            opacity: 0.8;
        }
        
        .department-btn:hover,
        .department-btn.active {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .department-btn.bed {
            background-color: var(--bed-color);
            color: white;
        }
        
        .department-btn.ced {
            background-color: var(--ced-color);
            color: white;
        }
        
        .department-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .filter-label {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }
        
        .select2-container {
            width: 100% !important;
        }
        
        .predict-btn {
            background: var(--success-color);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .predict-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(28, 200, 138, 0.4);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dashboard {
            display: none;
        }
        
        .dashboard.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn-download {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-download:hover {
            background-color: #3e8e41;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class='bx bx-line-chart'></i>
                ACLC College Enrollment Forecast
            </a>
        </div>
    </nav>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <div class="container">
        <!-- File Upload Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Upload Training Data</h5>
                        <div id="uploadArea" class="border rounded p-4 text-center">
                            <i class='bx bx-cloud-upload' style="font-size: 3rem; color: var(--primary-color);"></i>
                            <p class="mt-3">Drag and drop your CSV file here or click to browse</p>
                            <input type="file" id="fileInput" accept=".csv" class="d-none">
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- BED Dashboard -->
        <div id="bedDashboard" class="dashboard">
            <!-- Charts Section -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h5 class="card-title">Enrollment Trends</h5>
                            <div id="bedTrendChart" class="chart-container"></div>
                            <button class="btn btn-download mt-2" onclick="downloadChart('BED', 'trend')">Download Chart</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h5 class="card-title">Course Distribution</h5>
                            <div id="bedBarChart" class="chart-container"></div>
                            <button class="btn btn-download mt-2" onclick="downloadChart('BED', 'bar')">Download Chart</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Chart -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h5 class="card-title">Actual vs Forecast</h5>
                            <div id="bedComparisonChart" class="chart-container"></div>
                            <button class="btn btn-download mt-2" onclick="downloadChart('BED', 'comparison')">Download Chart</button>
                            <div id="bedMetrics" class="d-flex flex-wrap justify-content-center mt-3 d-none"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters Section -->
            <div class="row mb-4">
                <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-body text-center">
                    <h5 class="card-title">Filters</h5>
            
                    <!-- Compare Button -->
                    <form action="{{ url_for('comparefilter') }}" method="GET">
                        <button type="submit" class="btn btn-primary px-5 py-3" style="font-weight:600; border-radius:10px;">
                        COMPARE
                        </button>
                    </form>
            
                    </div>
                </div>
                </div>
            </div>
  
            

                            <!-- Generate Button -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button class="btn btn-primary" onclick="predict('BED')">Generate Forecast</button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>


                            <!-- Metrics Section -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div id="bedMetrics" class="d-flex flex-wrap gap-3 d-none"></div>
                                </div>
                            </div>

                            <!-- Charts Section -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Historical Enrollment</h5>
                                            <div class="chart-container">
                                                <button class="btn-download" onclick="downloadChart('bed', 'line')">
                                                    <i class="fas fa-download"></i> Download PNG
                                                </button>
                                                <div id="bedLineChart"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Course Distribution</h5>
                                            <div class="chart-container">
                                                <button class="btn-download" onclick="downloadChart('bed', 'bar')">
                                                    <i class="fas fa-download"></i> Download PNG
                                                </button>
                                                <div id="bedBarChart"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Actual vs Forecast</h5>
                                            <div class="chart-container">
                                                <button class="btn-download" onclick="downloadChart('bed', 'comparison')">
                                                    <i class="fas fa-download"></i> Download PNG
                                                </button>
                                                <div id="bedComparisonChart"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- CED Dashboard -->
        <div id="cedDashboard" class="dashboard">
            <!-- Charts Section -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h5 class="card-title">Enrollment Trends</h5>
                            <div id="cedTrendChart" class="chart-container"></div>
                            <button class="btn btn-download mt-2" onclick="downloadChart('CED', 'trend')">Download Chart</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h5 class="card-title">Course Distribution</h5>
                            <div id="cedBarChart" class="chart-container"></div>
                            <button class="btn btn-download mt-2" onclick="downloadChart('CED', 'bar')">Download Chart</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Chart -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h5 class="card-title">Actual vs Forecast</h5>
                            <div id="cedComparisonChart" class="chart-container"></div>
                            <button class="btn btn-download mt-2" onclick="downloadChart('CED', 'comparison')">Download Chart</button>
                            <div id="cedMetrics" class="d-flex flex-wrap justify-content-center mt-3 d-none"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h5 class="card-title">Filters</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group mb-3">
                                        <label class="filter-label">Course</label>
                                        <select class="form-control" id="cedCourse">
                                            <!-- Populated dynamically -->
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-3">
                                        <label class="filter-label">Year</label>
                                        <select class="form-control" id="cedYear">
                                            <!-- Populated dynamically -->
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-3">
                                        <label class="filter-label">Semester</label>
                                        <select class="form-control" id="cedSemester">
                                            <option value="1">First</option>
                                            <option value="2">Second</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button class="btn btn-primary" onclick="predict('CED')">Generate Forecast</button>
                                </div>
                            </div>

                            <!-- Metrics Section -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div id="cedMetrics" class="d-flex flex-wrap gap-3 d-none"></div>
                                </div>
                            </div>

                            <!-- Charts Section -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Historical Enrollment</h5>
                                            <div class="chart-container">
                                                <button class="btn-download" onclick="downloadChart('ced', 'line')">
                                                    <i class="fas fa-download"></i> Download PNG
                                                </button>
                                                <div id="cedLineChart"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Course Distribution</h5>
                                            <div class="chart-container">
                                                <button class="btn-download" onclick="downloadChart('ced', 'bar')">
                                                    <i class="fas fa-download"></i> Download PNG
                                                </button>
                                                <div id="cedBarChart"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Actual vs Forecast</h5>
                                            <div class="chart-container">
                                                <button class="btn-download" onclick="downloadChart('ced', 'comparison')">
                                                    <i class="fas fa-download"></i> Download PNG
                                                </button>
                                                <div id="cedComparisonChart"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- External Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        
        <script>
        (function() {
            // Function to update charts
            function updateCharts(data, department) {
                const deptColor = department === 'BED' ? '#e74a3b' : '#1cc88a';
                
                // Trend Chart
                const trendData = [{
                    x: data.dates,
                    y: data.enrollments,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Enrollment',
                    line: { color: deptColor }
                }];

                const layout = {
                    template: 'plotly_white',
                    showlegend: true,
                    height: 400,
                    margin: { t: 30, b: 40, l: 60, r: 40 }
                };

                Plotly.newPlot(`${department.toLowerCase()}TrendChart`, trendData, {
                    ...layout,
                    title: 'Enrollment Trends',
                    xaxis: { title: 'Year-Semester' },
                    yaxis: { title: 'Number of Students' }
                }).catch(err => console.error('Trend chart error:', err));

                // Bar Chart
                const barData = [{
                    x: Object.keys(data.course_data),
                    y: Object.values(data.course_data),
                    type: 'bar',
                    marker: { color: deptColor }
                }];

                Plotly.newPlot(`${department.toLowerCase()}BarChart`, barData, {
                    ...layout,
                    title: 'Course Distribution',
                    xaxis: { title: 'Course' },
                    yaxis: { title: 'Number of Students' }
                }).catch(err => console.error('Bar chart error:', err));

                // Comparison Chart
                const comparisonData = [
                    {
                        x: data.dates.slice(-4),
                        y: data.enrollments.slice(-4),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Actual',
                        line: { color: deptColor }
                    },
                    {
                        x: data.forecast_dates,
                        y: data.forecast_values,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Forecast',
                        line: { color: deptColor, dash: 'dash' }
                    }
                ];

                Plotly.newPlot(`${department.toLowerCase()}ComparisonChart`, comparisonData, {
                    ...layout,
                    title: 'Actual vs Forecast',
                    xaxis: { title: 'Year-Semester' },
                    yaxis: { title: 'Number of Students' }
                }).catch(err => console.error('Comparison chart error:', err));

                // Update metrics if available
                if (data.metrics) {
                    updateMetrics(department, data.metrics);
                }
            }
            // Application state management
            const appState = {
                charts: {},
                data: {},
                department: 'BED',
                ui: null
            };

            // Initialize everything when the document is ready
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize UI state
                appState.ui = {
                    // Dashboards
                    bedDashboard: document.getElementById('bedDashboard'),
                    cedDashboard: document.getElementById('cedDashboard'),
                    // Forms
                    bedCourse: document.getElementById('bedCourse'),
                    bedYear: document.getElementById('bedYear'),
                    bedSemester: document.getElementById('bedSemester'),
                    cedCourse: document.getElementById('cedCourse'),
                    cedYear: document.getElementById('cedYear'),
                    cedSemester: document.getElementById('cedSemester'),
                    // File handling
                    dropZone: document.getElementById('uploadArea'),
                    fileInput: document.getElementById('fileInput'),
                    loader: document.getElementById('loadingOverlay')
                };



                // Initialize application
                initializeDashboard();
                setupEventListeners();
                setupFileHandlers();
                initializeCharts();
            });

            function initializeDashboard() {
                // Hide all dashboards
                document.querySelectorAll('.dashboard').forEach(dash => {
                    dash.style.display = 'none';
                });

                // Switch to BED department
                switchDepartment('BED');
            }

            function setupEventListeners() {
                document.querySelectorAll('.department-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const department = this.dataset.department;
                        switchDepartment(department);
                    });
                });

                document.querySelectorAll('.predict-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const department = appState.department;
                        await predict(department);
                    });
                });
            }

            async function predict(department) {
                showLoading();
                const dept = department.toLowerCase();

                try {
                    // Get form elements
                    const courseSelect = document.getElementById(`${dept}Course`);
                    const yearSelect = document.getElementById(`${dept}Year`);
                    const semesterSelect = document.getElementById(`${dept}Semester`);

                    // Validate form elements
                    if (!courseSelect || !yearSelect || !semesterSelect) {
                        throw new Error('Missing form elements');
                    }

                    // Validate selections
                    if (!courseSelect.value) {
                        throw new Error('Please select a course');
                    }
                    if (!yearSelect.value) {
                        throw new Error('Please select a year');
                    }
                    if (!semesterSelect.value) {
                        throw new Error('Please select a semester');
                    }

                    // Prepare request data
                    const data = {
                        department: department,
                        course: courseSelect.value,
                        year: yearSelect.value,
                        semester: semesterSelect.value
                    };

                    console.log('Sending prediction request:', data);

                    // Make prediction request
                    const response = await fetch('/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    // Handle response
                    const result = await response.json();
                    console.log('Received prediction result:', result);

                    if (result.error) {
                        throw new Error(result.error);
                    }

                    // Show the result section
                    const resultSection = document.getElementById('resultSection');
                    if (resultSection) {
                        resultSection.classList.remove('d-none');
                    }

                    // Update charts and metrics
                    updateCharts(dept, result);
                    updateMetrics(dept, result.metrics);

                    // Show success message
                    const toast = document.createElement('div');
                    toast.className = 'toast align-items-center text-white bg-success border-0';
                    toast.setAttribute('role', 'alert');
                    toast.setAttribute('aria-live', 'assertive');
                    toast.setAttribute('aria-atomic', 'true');
                    toast.innerHTML = `
                        <div class="d-flex">
                            <div class="toast-body">
                                Forecast generated successfully!
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    const bsToast = new bootstrap.Toast(toast);
                    bsToast.show();
                    toast.addEventListener('hidden.bs.toast', () => toast.remove());
                } catch (error) {
                    console.error('Error:', error);
                    const toast = document.createElement('div');
                    toast.className = 'toast align-items-center text-white bg-danger border-0';
                    toast.setAttribute('role', 'alert');
                    toast.setAttribute('aria-live', 'assertive');
                    toast.setAttribute('aria-atomic', 'true');
                    toast.innerHTML = `
                        <div class="d-flex">
                            <div class="toast-body">
                                Error: ${error.message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    const bsToast = new bootstrap.Toast(toast);
                    bsToast.show();
                    toast.addEventListener('hidden.bs.toast', () => toast.remove());
                } finally {
                    hideLoading();
                }
            }

            function switchDepartment(department) {
                // Update active state of buttons
                document.querySelectorAll('.department-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.department === department) {
                        btn.classList.add('active');
                    }
                });

                // Hide all dashboards
                document.querySelectorAll('.dashboard').forEach(dash => {
                    dash.style.display = 'none';
                });

                // Show selected dashboard
                const dashboardId = department.toLowerCase() + 'Dashboard';
                document.getElementById(dashboardId).style.display = 'block';

                // Update current department
                appState.department = department;

                // Update filters based on department
                fetch('/get_filters')
                    .then(response => response.json())
                    .then(data => {
                        const courses = data.courses[department] || [];
                        const courseSelect = document.getElementById(department.toLowerCase() + 'Course');
                        courseSelect.innerHTML = courses.map(course => 
                            `<option value="${course}">${course}</option>`
                        ).join('');

                        const yearSelect = document.getElementById(department.toLowerCase() + 'Year');
                        yearSelect.innerHTML = data.years.map(year => 
                            `<option value="${year}">${year}</option>`
                        ).join('');
                    })
                    .catch(error => {
                        console.error('Error fetching filters:', error);
                    });
            }

            async function updateFilters(department) {
                try {
                    const response = await fetch('/get_filters');
                    const data = await response.json();

                    const courses = data.courses[department] || [];
                    const years = data.years || [];

                    // Get department elements
                    const courseSelect = document.getElementById(department.toLowerCase() + 'Course');
                    const yearSelect = document.getElementById(department.toLowerCase() + 'Year');

                    if (courseSelect) {
                        courseSelect.innerHTML = courses
                            .map(course => `<option value="${course}">${course}</option>`)
                            .join('');

                        // Initialize Select2 for course
                        $(courseSelect).select2({
                            theme: 'bootstrap4',
                            placeholder: 'Select Course'
                        });
                    }

                    if (yearSelect) {
                        yearSelect.innerHTML = years
                            .map(year => `<option value="${year}">${year}</option>`)
                            .join('');

                        // Initialize Select2 for year
                        $(yearSelect).select2({
                            theme: 'bootstrap4',
                            placeholder: 'Select Year Level'
                        });
                    }
                } catch (error) {
                    console.error('Error fetching filters:', error);
                }
            }

            // Loading overlay reference
            const loadingOverlay = document.getElementById('loadingOverlay');

            function showLoading() {
                if (loadingOverlay) loadingOverlay.style.display = 'flex';
            }

            function hideLoading() {
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            }

            function handleFile(file) {
                showLoading();
                const formData = new FormData();
                formData.append('file', file);

                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    appState.data = data;
                    updateCharts(appState.department, data);
                    updateMetrics(appState.department, data.metrics);
                    const resultSection = document.getElementById('resultSection');
                    if (resultSection) {
                        resultSection.classList.remove('d-none');
                        resultSection.classList.add('animate__animated', 'animate__fadeIn');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing the file: ' + error.message);
                })
                .finally(() => {
                    hideLoading();
                });
            }

            function handleFileUpload(event) {
                event.preventDefault();
                const fileInput = document.getElementById('csvFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file first!');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';

                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Process the response data
                    console.log('Upload successful:', data);
                    
                    // Group courses by department
                    const bedData = {};
                    const cedData = {};
                    
                    Object.entries(data).forEach(([course, courseData]) => {
                        if (course.startsWith('BSBA')) {
                            bedData[course] = courseData;
                        } else {
                            cedData[course] = courseData;
                        }
                    });
                    
                    // Update BED charts
                    if (Object.keys(bedData).length > 0) {
                        const firstCourse = Object.keys(bedData)[0];
                        const courseData = bedData[firstCourse];
                        
                        updateCharts({
                            dates: courseData.historical.dates,
                            enrollments: courseData.historical.values,
                            forecast_dates: courseData.predictions.dates,
                            forecast_values: courseData.predictions.values,
                            metrics: courseData.metrics,
                            course_data: Object.fromEntries(
                                Object.entries(bedData).map(([course, data]) => [
                                    course,
                                    data.historical.values[data.historical.values.length - 1]
                                ])
                            )
                        }, 'BED');
                    }
                    
                    // Update CED charts
                    if (Object.keys(cedData).length > 0) {
                        const firstCourse = Object.keys(cedData)[0];
                        const courseData = cedData[firstCourse];
                        
                        updateCharts({
                            dates: courseData.historical.dates,
                            enrollments: courseData.historical.values,
                            forecast_dates: courseData.predictions.dates,
                            forecast_values: courseData.predictions.values,
                            metrics: courseData.metrics,
                            course_data: Object.fromEntries(
                                Object.entries(cedData).map(([course, data]) => [
                                    course,
                                    data.historical.values[data.historical.values.length - 1]
                                ])
                            )
                        }, 'CED');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                })
                .finally(() => {
                    // Hide loading overlay
                    document.getElementById('loadingOverlay').style.display = 'none';
                });
            }

            function initializeCharts() {
                const defaultLayout = {
                    showlegend: true,
                    template: 'plotly_white',
                    margin: { t: 50, r: 20, b: 50, l: 50 }
                };

                // Initialize charts for both departments
                ['bed', 'ced'].forEach(dept => {
                    // Line Chart
                    Plotly.newPlot(`${dept}LineChart`, [], {
                        ...defaultLayout,
                        title: 'Enrollment Trends',
                        xaxis: { title: 'Semester' },
                        yaxis: { title: 'Number of Students' }
                    });
                    
                    // Bar Chart
                    Plotly.newPlot(`${dept}BarChart`, [], {
                        ...defaultLayout,
                        title: 'Course Distribution',
                        xaxis: { title: 'Course' },
                        yaxis: { title: 'Number of Students' }
                    });
                    
                    // Comparison Chart
                    Plotly.newPlot(`${dept}ComparisonChart`, [], {
                        ...defaultLayout,
                        title: 'Actual vs Forecast',
                        xaxis: { title: 'Semester' },
                        yaxis: { title: 'Number of Students' }
                    });
                });
            }

            function updateCharts(department, data) {
                console.log('Updating charts with data:', data);
                const deptColor = department === 'bed' ? '#e74a3b' : '#1cc88a';

                try {
                    // Line chart data
                    const lineData = [{
                        x: data.dates,
                        y: data.values,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Historical',
                        line: { color: deptColor }
                    }];

                    // Bar chart data
                    const barData = [{
                        x: data.courses,
                        y: data.course_enrollments,
                        type: 'bar',
                        marker: { color: deptColor }
                    }];

                    // Comparison chart data
                    const comparisonData = [
                        {
                            x: data.actual_dates,
                            y: data.actual_values,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Actual',
                            line: { color: deptColor }
                        },
                        {
                            x: data.forecast_dates,
                            y: data.forecast_values,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Forecast',
                            line: { color: deptColor, dash: 'dash' }
                        }
                    ];

                    const layout = {
                        showlegend: true,
                        template: 'plotly_white',
                        margin: { t: 50, r: 20, b: 50, l: 50 },
                        hovermode: 'closest'
                    };

                    // Update charts with error handling
                    Plotly.react(`${department}LineChart`, lineData, {
                        ...layout,
                        title: 'Enrollment Trends',
                        xaxis: { title: 'Semester' },
                        yaxis: { title: 'Number of Students' }
                    }).catch(err => console.error('Line chart error:', err));

                    Plotly.react(`${department}BarChart`, barData, {
                        ...layout,
                        title: 'Course Distribution',
                        xaxis: { title: 'Course' },
                        yaxis: { title: 'Number of Students' }
                    }).catch(err => console.error('Bar chart error:', err));

                    Plotly.react(`${department}ComparisonChart`, comparisonData, {
                        ...layout,
                        title: 'Actual vs Forecast',
                        xaxis: { title: 'Semester' },
                        yaxis: { title: 'Number of Students' }
                    }).catch(err => console.error('Comparison chart error:', err));

                } catch (error) {
                    console.error('Error updating charts:', error);
                }

                // Comparison chart
                const actualVsForecast = [
                    {
                        x: data.dates.slice(-4),
                        y: data.enrollments.slice(-4),
                        name: 'Actual',
                        type: 'scatter',
                        line: { color: deptColor }
                    },
                    {
                        x: data.forecast_dates,
                        y: data.forecast_values,
                        name: 'Forecast',
                        type: 'scatter',
                        line: { color: deptColor, dash: 'dash' }
                    }
                ];

                Plotly.react(`${department}ComparisonChart`, actualVsForecast, {
                    title: 'Actual vs Forecast',
                    xaxis: { title: 'Semester' },
                    yaxis: { title: 'Number of Students' },
                    showlegend: true,
                    template: 'plotly_white'
                });
            }

            function updateMetrics(department, metrics) {
                const metricsContainer = document.getElementById(`${department}Metrics`);
                if (!metricsContainer) return;

                // Create metrics badges
                const html = Object.entries(metrics).map(([key, value]) => {
                    const formattedValue = key === 'mape' ? 
                        `${(value * 100).toFixed(2)}%` : 
                        value.toFixed(2);
                    return `<div class="metrics-badge">${key.toUpperCase()}: ${formattedValue}</div>`;
                }).join('');

                metricsContainer.innerHTML = html;
                metricsContainer.classList.remove('d-none');
            }

            async function downloadChart(department, chartType) {
                try {
                    const response = await fetch(`/download_chart/${department}/${chartType}`);
                    if (!response.ok) {
                        throw new Error('Failed to download chart');
                    }
                    
                    // Create a blob from the response
                    const blob = await response.blob();
                    
                    // Create a temporary link and trigger download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${department}_${chartType}_chart.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error downloading chart: ' + error.message);
                }
            }

            function getColor(index, isDashed = false) {
                const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'];
                return isDashed ? colors[index] + '80' : colors[index];
            }
        })();
        </script>
    </body>
</html>
